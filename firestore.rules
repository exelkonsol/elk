rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function unchanged(field) {
      return request.resource.data[field] == resource.data[field];
    }

    function incremented(field) {
      return request.resource.data[field] == resource.data[field] + 1;
    }

    function onlyIncrement(field) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly([field])
        && incremented(field)
        && unchanged("cycle")
        && unchanged("cycleStartedAt")
        && unchanged("cycleEndsAt");
    }

    function isValidInitialDoc() {
      return request.resource.data.keys().hasOnly([
        "isolation",
        "anchoring",
        "distraction",
        "sublimation",
        "cycle",
        "cycleStartedAt",
        "cycleEndsAt"
      ])
      && request.resource.data.isolation == 0
      && request.resource.data.anchoring == 0
      && request.resource.data.distraction == 0
      && request.resource.data.sublimation == 0
      && request.resource.data.cycle == 1
      && request.resource.data.cycleStartedAt == null
      && request.resource.data.cycleEndsAt == null;
    }

    match /artifacts/{appId}/public/data/mechanisms/current {
      allow read: if true;
      allow create: if isSignedIn() && isValidInitialDoc();
      allow update: if isSignedIn() && (
        onlyIncrement("isolation")
        || onlyIncrement("anchoring")
        || onlyIncrement("distraction")
        || onlyIncrement("sublimation")
      );
      allow delete: if false;
    }

    match /artifacts/{appId}/public/data/mechanisms/history/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
